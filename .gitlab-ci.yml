# GitLab CI/CD - ZyeutÃ© V3 Quebec Social Platform
# Modernized pipeline: Node 22 + Parallel Testing + Render Deployment

image: node:22

stages:
  - install
  - test
  - build
  - security
  - deploy

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - node_modules/

# ===== INSTALL DEPENDENCIES =====
install:
  stage: install
  script:
    - npm ci
  artifacts:
    paths:
      - node_modules/
    expire_in: 1 hour

# ===== PARALLEL TESTING (3 SHARDS) =====
test:shard-1:
  stage: test
  needs: [install]
  script:
    - npx vitest run --shard=1/3
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    when: always
    reports:
      junit: junit.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml

test:shard-2:
  stage: test
  needs: [install]
  script:
    - npx vitest run --shard=2/3
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    when: always
    reports:
      junit: junit.xml

test:shard-3:
  stage: test
  needs: [install]
  script:
    - npx vitest run --shard=3/3
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    when: always
    reports:
      junit: junit.xml

# ===== BUILD APPLICATION =====
build:
  stage: build
  needs: [install]
  script:
    - npm run build
  artifacts:
    paths:
      - dist/
    expire_in: 1 day

# ===== SECURITY SCANNING =====
sast:
  stage: security
  allow_failure: true
  script:
    - echo "SAST scanning enabled via GitLab Ultimate"
  artifacts:
    when: always

secret_detection:
  stage: security
  allow_failure: true
  script:
    - echo "Secret detection enabled via GitLab Ultimate"
  artifacts:
    when: always

container_scanning:
  stage: security
  allow_failure: true
  script:
    - echo "Container scanning enabled via GitLab Ultimate"
  artifacts:
    when: always

# ===== DEPLOY TO RENDER =====
deploy_production:
  stage: deploy
  needs: [build]
  script:
    - |
      echo "ðŸš€ Deploying to Render (zyeute-production)"
      if [ -z "$RENDER_DEPLOY_HOOK" ]; then
        echo "âŒ Error: RENDER_DEPLOY_HOOK not configured"
        echo "Configure it in: Settings > CI/CD > Variables"
        exit 1
      fi
      curl -X POST "$RENDER_DEPLOY_HOOK"
      echo "âœ… Deployment triggered successfully"
  environment:
    name: production
    url: https://zyeute-production.onrender.com
  only:
    - main
  when: manual