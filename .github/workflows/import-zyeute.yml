# comet-import-zyeute.yml
# Generic CI job compatible with Comet or any shell-based runner
name: import-zyeute

# Trigger manually or via your CI schedule
on:
  workflow_dispatch: {}

jobs:
  import:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout monorepo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git identity
        run: |
          git config user.name "ci-bot"
          git config user.email "ci-bot@example.com"

      - name: Add source remote and fetch
        env:
          SOURCE_REPO: "https://github.com/brandonlacoste9-tech/ZyeuteV5.git"
          SOURCE_BRANCH: "main"
        run: |
          git remote add zyeute-src "$SOURCE_REPO" || true
          git fetch zyeute-src --tags --prune

      - name: Create import branch
        run: |
          BRANCH="import/zyeute-$(date +%s)"
          git checkout -b "$BRANCH"
          echo "IMPORT_BRANCH=$BRANCH" > import_branch.env

      - name: Import subtree into zyeute directory
        run: |
          # If zyeute/ does not exist, add; otherwise pull to update
          if [ ! -d "zyeute" ]; then
            git subtree add --prefix=zyeute zyeute-src "$SOURCE_BRANCH"
          else
            git subtree pull --prefix=zyeute zyeute-src "$SOURCE_BRANCH"
          fi

      - name: Install dependencies and run tests
        run: |
          if [ -d "zyeute" ]; then
            cd zyeute || exit 0
            if [ -f package.json ]; then
              npm ci --no-audit --no-fund
              npm test || echo "Tests failed but continuing"
            fi
            cd ..
          fi

      - name: Commit changes
        run: |
          git add zyeute
          git commit -m "chore: import zyeute via CI" || echo "No changes to commit"

      - name: Push branch
        env:
          PAT: ${{ secrets.PAT }}
        run: |
          source import_branch.env
          git push https://x-access-token:${PAT}@github.com/${{ github.repository }} HEAD:$IMPORT_BRANCH

      - name: Create Pull Request
        env:
          PAT: ${{ secrets.PAT }}
        run: |
          source import_branch.env
          API_URL="https://api.github.com/repos/${{ github.repository }}/pulls"
          BODY=$(jq -n --arg title "Import zyeute" --arg head "$IMPORT_BRANCH" --arg base "main" --arg body "Automated import of zyeute into monorepo" '{title:$title, head:$head, base:$base, body:$body}')
          curl -s -X POST -H "Authorization: token ${PAT}" -H "Accept: application/vnd.github+json" "$API_URL" -d "$BODY" | jq -r '.html_url // "PR creation failed"'
