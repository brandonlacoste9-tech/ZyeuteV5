# OpenCode Flow Configuration for GitLab
# This configuration enables OpenCode to work with GitLab issues and merge requests

image: node:22-slim

commands:
  - echo "Installing opencode"
  - npm install --global opencode-ai
  - echo "Installing glab CLI for GitLab operations"
  - export GITLAB_TOKEN=$GITLAB_TOKEN
  - apt-get update --quiet && apt-get install --yes curl wget gpg git && rm --recursive --force /var/lib/apt/lists/*
  - curl --silent --show-error --location "https://raw.githubusercontent.com/upciti/wakemeops/main/assets/install_repository" | bash
  - apt-get install --yes glab
  - echo "Configuring glab"
  - echo $GITLAB_HOST
  - echo "Configuring git"
  - git config --global user.email "opencode@gitlab.com"
  - git config --global user.name "OpenCode"
  - echo "Testing glab"
  - glab issue list
  - echo "Running OpenCode"
  - |
    opencode run "
    You are an AI assistant helping with GitLab operations.
    
    Context: $AI_FLOW_CONTEXT
    Task: $AI_FLOW_INPUT
    Event: $AI_FLOW_EVENT
    
    Please execute the requested task using the available GitLab tools.
    Be thorough in your analysis and provide clear explanations.
    
    <important>
    Use the glab CLI to access data from GitLab. The glab CLI has already been authenticated. You can run the corresponding commands.
    
    When you complete your work create a new Git branch, if you aren't already working on a feature branch, with the format of 'feature/<short description of feature>' and check in/push code.
    
    When you check in and push code, you will need to use the access token stored in GITLAB_TOKEN and the user OpenCode.
    
    Lastly, after pushing the code, if a merge request doesn't already exist, create a new merge request for the branch and link it to the issue using:
    glab mr create --title \"<title>\" --description \"<desc>\" --source-branch \"<branch>\" --target-branch \"<branch>\"
    
    If you are asked to summarize a merge request or issue, or asked to provide more information then please post back a note to the merge request / issue so that the user can see it.
    </important>
    "

variables:
  - GITLAB_TOKEN
  - GITLAB_HOST
  - PERPLEXITY_API_KEY